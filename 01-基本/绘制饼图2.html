<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
    <style>
      canvas {
        display: block;
        margin: 10px auto;
        border: 1px solid #000;
      }
    </style>
  </head>
  <body>
    <canvas width="600" height="400"></canvas>
  </body>
  <script>
    function PieChart(cxt) {
      this.myCan = document.querySelector("canvas");
      this.cxt = cxt || this.myCan.getContext("2d");
      this.w = this.cxt.canvas.width;
      this.h = this.cxt.canvas.height;
      this.x = this.w / 2 + 30;
      this.y = this.h / 2;
      this.r = 150;
      this.line = 20;
      this.rectW = 30;
      this.rectH = 15;
      this.rectL = 10;
      this.rectT = 6;
    }
    PieChart.prototype.ranNum = function (min, max) {
      return function () {
        return parseInt(Math.random() * (max - min + 1) + min);
      };
    };
    PieChart.prototype.ranColor = function () {
      this.color = this.ranNum(0, 255);
      return `rgb(${this.color()},${this.color()},${this.color()})`;
    };
    PieChart.prototype.drawRect = function (str, n, rectColor) {
      this.cxt.beginPath();
      let rectEndT = this.rectT * (n + 1) + this.rectH * n;
      this.cxt.fillRect(this.rectL, rectEndT, this.rectW, this.rectH);
      // 配套相应的文字
      this.cxt.font = "12px Miscrosoft Yahei";
      this.cxt.textBaseline = "middle";
      this.cxt.fillText(str, this.rectL + this.rectW + this.rectT, rectEndT + this.rectH / 2);
      this.cxt.fillStyle = rectColor;
      this.cxt.fill();
    };
    PieChart.prototype.drawArc = function (sAngle, eAngle, color) {
      this.cxt.moveTo(this.x, this.y);
      this.cxt.arc(this.x, this.y, this.r, sAngle, eAngle);
      this.cxt.fillStyle = color;
      this.cxt.fill();
    };
    PieChart.prototype.drawTitle = function (sAngle, angle, color, str) {
      this.cxt.beginPath();
      this.endX = Math.cos(sAngle + angle / 2) * (this.r + this.line) + this.x;
      this.endY = Math.sin(sAngle + angle / 2) * (this.r + this.line) + this.y;
      this.cxt.moveTo(this.x, this.y);
      this.cxt.lineTo(this.endX, this.endY);
      this.cxt.strokeStyle = color;
      this.cxt.stroke();

      this.cxt.beginPath();
      this.textWidth = this.cxt.measureText(str).width;
      this.cxt.moveTo(this.endX, this.endY);
      this.lineEndX = this.endX > this.x ? this.endX + this.textWidth : this.endX - this.textWidth;
      this.cxt.lineTo(this.lineEndX, this.endY);
      this.cxt.strokeStyle = color;
      this.cxt.stroke();

      // 绘制标题
      this.cxt.beginPath();
      this.cxt.textBaseline = "bottom";
      this.cxt.fillText(str, this.x > this.endX ? this.lineEndX : this.endX, this.endY);
    };
    PieChart.prototype.drawPie = function (data) {
      if (!data.length) {
        return;
      }
      let sum = 0;
      let start = 0;
      let end = 0;
      data.forEach(function (item) {
        sum += item.num;
      });
      data.map(function (item) {
        item.num = (item.num / sum) * Math.PI * 2;
        return item;
      });
      console.log(data);
      for (var i = 0; i < data.length; i++) {
        let ran = this.ranColor();
        this.cxt.beginPath();
        if (i == 0) {
          start = 0;
          end = data[i].num;
        } else {
          start += data[i - 1].num;
          end += data[i].num;
        }
        this.drawArc(start, end, ran);

        this.drawTitle(start, data[i].num, ran, data[i].title);

        this.drawRect(data[i].title, i, ran);
      }
    };

    var data = [
      {
        title: "不及格人数",
        num: 20,
      },
      {
        title: "刚好及格",
        num: 50,
      },
      {
        title: "良好",
        num: 30,
      },
    ];
    let pie = new PieChart();
    console.log(pie.ranColor());
    pie.drawPie(data);
  </script>
</html>
